# 3.2 Machine Learning in BigQuery (BQML)

**[↑ Up](README.md)** | **[← Previous](3.1-optimization.md)** | **[Next →](3.3-export-serving.md)**

---

**Folder Structure:**
```
project/
├── 3.1-optimization.md
├── 3.2-bqml-training.md  <-- You are here
├── 3.3-export-serving.md
└── 3.4-prediction-test.md
```

## Objective

We will build a machine learning model directly inside BigQuery to predict the `tip_amount` of a taxi ride. We will use **Linear Regression** since the target variable is continuous. We will also perform feature engineering using SQL.

## 1. Feature Engineering & Model Training

BQML allows us to create and train models using standard SQL. We need to prepare our features carefully.

*   **Categorical Features:** `PULocationID`, `DOLocationID`, and `payment_type` are stored as integers but represent categories. We must `CAST` them to `STRING` so BQML treats them correctly (one-hot encoding).
*   **Target:** `tip_amount`.

### Step 1: Open Query Editor

1.  In the BigQuery Console, click **+ COMPOSE NEW QUERY** to open a fresh Editor tab.
2.  Paste the following SQL into the editor.
3.  **Crucial**: Replace `your_project.your_dataset` with your actual Project ID and Dataset Name (should be the same one you used in step 3.1).

### Step 2: Run the Training Query

```sql
CREATE OR REPLACE MODEL `your_project.your_dataset.tip_model`
OPTIONS(
  model_type='linear_reg',
  input_label_cols=['tip_amount'],
  data_split_method='AUTO_SPLIT'
) AS
SELECT
  -- 1. Feature Engineering: Cast IDs to String for One-Hot Encoding
  CAST(PULocationID AS STRING) AS PULocationID,
  CAST(DOLocationID AS STRING) AS DOLocationID,
  CAST(payment_type AS STRING) AS payment_type,
  
  -- 2. Numerical Features
  passenger_count,
  trip_distance,
  fare_amount,
  tolls_amount,
  
  -- 3. Label (Target)
  tip_amount
FROM
  `your_project.your_dataset.yellow_tripdata_optimized`
WHERE
    -- 4. Data Quality Filters
    fare_amount > 0
    AND trip_distance > 0
    AND tip_amount >= 0;
```

**Explanation:**

*   **`model_type='linear_reg'`**: Specifies the algorithm.
*   **`data_split_method='AUTO_SPLIT'`**: Automatically separates data into training and evaluation sets.
*   **`CAST(... AS STRING)`**: Forces BigQuery to treat these numbers as categorical distinct values rather than continuous numbers.

**Note on Execution Time:**
This query will take a few minutes to run (typically 2-5 minutes) as it is training a model on gigabytes of data.

## 2. Evaluate the Model

After training is complete (green checkmark next to the query execution):

1.  Click **+ COMPOSE NEW QUERY** again.
2.  Paste and run the evaluation query:

```sql
SELECT
  *
FROM
  ML.EVALUATE(MODEL `your_project.your_dataset.tip_model`, (
    SELECT
      CAST(PULocationID AS STRING) AS PULocationID,
      CAST(DOLocationID AS STRING) AS DOLocationID,
      CAST(payment_type AS STRING) AS payment_type,
      passenger_count,
      trip_distance,
      fare_amount,
      tolls_amount,
      tip_amount
    FROM
      `your_project.your_dataset.yellow_tripdata_optimized`
    WHERE
      DATE(tpep_pickup_datetime) = '2021-06-01' -- Evaluate on a specific recent day
  ));
```

## 3. Predict

You can now use the model to make predictions on new data within BigQuery.

1.  Open a new query tab.
2.  Run the following:

```sql
SELECT
  *
FROM
  ML.PREDICT(MODEL `your_project.your_dataset.tip_model`, (
    SELECT
      '132' AS PULocationID, -- JFK Airport
      '230' AS DOLocationID, -- Times Sq
      '1' AS payment_type,   -- Credit Card
      1.0 AS passenger_count,
      20.5 AS trip_distance,
      55.0 AS fare_amount,
      6.0 AS tolls_amount
  ));
```
